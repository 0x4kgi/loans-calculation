<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="css/vendors/bootstrap.min.css">

    <title>Loan calculation</title>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="form-group col-sm">
                <label for="sel1">Select profile:</label>
                <select class="form-control" id="loanProfile">
                    <option value="profile1">profile1</option>
                    <option value="profile2">profile2</option>
                    <option value="profile3">profile3</option>
                </select>
                
            </div> 
        </div>
        <div class="row">
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Loan Amount:</span>
                </div>
                <div class="input-group-prepend">
                    <span class="input-group-text ">$</span>
                </div>
                <input type="text" class="form-control text-right" placeholder="10000" id="txtLoans">
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Interest:</span>
                </div>                
                <input 
                    type="text" 
                    class="form-control text-right" 
                    placeholder="2.5" 
                    id="txtInterest"
                    onkeyup="updateAnnum(this)"
                >
                <div class="input-group-append">
                    <span class="input-group-text">% /month</span>
                </div>
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Interest:</span>
                </div>                
                <input type="text" class="form-control text-right" placeholder="0.208" id="txtInterestAnnum" readonly>
                <div class="input-group-append">
                    <span class="input-group-text">% /annum</span>
                </div>
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Terms:</span>
                </div>                
                <input type="text" class="form-control text-right" placeholder="3" id="txtYears">
                <div class="input-group-append">
                    <span class="input-group-text">years</span>
                </div>
            </div>                      
        </div>
        <br>
        <div class="row">
            <div class="col-sm text-center">
                <button type="button" class="btn btn-primary" id="btnUpdateTable">Set Values</button>
            </div>
        </div>        
    </div>
    <br>
    <div class="container">
        <div class="row">
            <table class="table table-bordered table-sm col-sm">
                <thead>
                    <th>Month #</th>
                    <th>Balance</th>
                    <th>Amount to pay</th>
                    <th>Payment</th>
                    <th>Interest</th>
                    <th>Principal</th>
                    <th>New Balance</th>
                </thead>
                <tbody id="tblLoans">
                </tbody>
            </table>
        </div>
    </div>
    <script src="scripts/vendors/jquery-3.4.1.slim.min.js"></script>
    <script src="scripts/vendors/popper.min.js"></script>
    <script src="scripts/vendors/bootstrap.min.js"></script>
    <script src="scripts/constants.js"></script>
    <script src="scripts/classes/main.js"></script>
    <script>
        var profiles = {
            profile1: null,
            profile2: null,
            profile3: null,
        };

        var selectedProfile, loanAmount, interestRate, monthsCount;

        $(document).ready(function() {
            $("button#btnUpdateTable").on("click", function() {
                selectedProfile = $("select#loanProfile").val();  
                createLoanProfile(selectedProfile);              
            });

            $("select#loanProfile").on("change", function() {
                $("input#txtLoans").val("");
                $("input#txtInterest").val("");
                $("input#txtYears").val("");

                selectedProfile = $("select#loanProfile").val();

                let profileData = profiles[selectedProfile];

                if(profileData !== null) {
                    loadSelectedProfile(profileData);
                } else {
                    tableDisplay();
                }

            });
        });

        function createLoanProfile(selectedProfile) {
            loanAmount = $("input#txtLoans").val() || DEFAULT_LOAN_AMOUNT;
            interestRate = ($("input#txtInterest").val() || DEFAULT_INTEREST) / 100;
            monthsCount = ($("input#txtYears").val() || DEFAULT_YEARS) * 12;

            let profileData = new LoanProfile({
                loanAmount: loanAmount,
                interestRate: interestRate,
                term: monthsCount,
            });

            profiles[selectedProfile] = profileData;
            
            tableDisplay(profileData);
        }

        function loadSelectedProfile(profileData) {
            $("input#txtLoans").val(profileData.loanAmount);
            $("input#txtInterest").val(profileData.interestRate * 100);
            $("input#txtYears").val(profileData.term / 12);

            tableDisplay(profileData);
        }

        function tableDisplay(profileData) {
            $("tbody#tblLoans").html("");

            if(profileData === undefined) return;

            for (let i = 0; i < profileData.term; i += 1) { 
                const row = profileData.getMonthData(i);           
                appendToTable({
                    month: i,
                    balance: row.balance, 
                    toPay: row.toPay, 
                    interestValue: row.interest, 
                    principal: row.principal, 
                    newBalance: row.newBalance,
                    payment: row.payment                    
                });                 
            }
        }

        function appendToTable({month, balance, toPay, interestValue, principal, newBalance, payment}) {
            $("tbody#tblLoans").append(`
                <tr id="rowMonth${month}">
                    <td class="text-center">${month + 1}</td>
                    <td class="text-right" 
                        id="balance${month}">
                        ${numberFormat(balance)}
                    </td>
                    <td class="text-right" 
                        id="payment${month}">
                        ${numberFormat(toPay)}
                    </td>
                    <td class="text-right">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <button 
                                    class="btn btn-outline-secondary" 
                                    type="button"
                                    onClick="equalizePayments(${month});">
                                    &gt;&gt;
                                </button>    
                            </div>
                            <input 
                                type="text" 
                                class="form-control text-right" 
                                placeholder="0.00" 
                                id="payment${month}"
                                value="${payment}"
                                onKeyUp="paymentTextChange(this,${month})"
                            >
                        </div>                        
                    </td>
                    <td class="text-right" 
                        id="interest${month}">
                        ${numberFormat(interestValue)}
                    </td>
                    <td class="text-right" 
                        id="principal${month}">
                        ${numberFormat(principal)}
                    </td>
                    <td class="text-right" 
                        id="newBalance${month}">
                        ${numberFormat(newBalance)}
                    </td>
                </tr>
            `);    
        }

        function paymentTextChange(control,monthIndex) {
            let value = stringToNumber($(`input#payment${monthIndex}`).val());

            profiles[selectedProfile].setMonthData(value, monthIndex);

            updateTableDisplay(monthIndex);
        }

        function updateTableDisplay(monthIndex) {
            for (let i = monthIndex; i < monthsCount; i++) {
                let data = profiles[selectedProfile].getMonthData(i);

                $(`td#balance${i}`).html(numberFormat(data.balance));
                $(`td#payment${i}`).html(numberFormat(data.toPay));
                $(`td#interest${i}`).html(numberFormat(data.interest));
                $(`td#principal${i}`).html(numberFormat(data.principal));
                $(`td#newBalance${i}`).html(numberFormat(data.newBalance));                
            }            
        }

        function numberFormat(number, places = 2) {
            let rounded =  Math.round(number * Math.pow(10, places)) / Math.pow(10, places);
            
            num = parseFloat(rounded).toLocaleString(undefined, {maximumFractionDigits:places});

            let decimals = num.toString().split(".")[1];
            if(decimals === undefined){
                num += ".".padEnd(places + 1, 0);
            } else if(decimals.length < places) {
                num += "0".padEnd(places - decimals.length);
            }

            return num;
        }

        function stringToNumber(data) {
            str = data.toString();

            if (str.indexOf(".") > -1) {
                split = str.split(".");

                if(split[1] === undefined) return 0;

                split[0] = split[0].replace(/\D+/g, "");
                split[1] = split[1].replace(/\D+/g, "");

                return parseFloat(`${split[0]}.${split[1]}`);
            } else {
                return str.replace(/\D+/g, "");
            }   
        }

        function updateAnnum(control) {
            let value = stringToNumber(control.value) * 12;

            $("input#txtInterestAnnum").val(numberFormat(value,2));
        }
        
        function equalizePayments(monthIndex) {
            let monthly = stringToNumber($(`td#payment${monthIndex}`).html());
            $(`input#payment${monthIndex}`).val(monthly);
            paymentTextChange($(`input#payment${monthIndex}`), monthIndex);
        }
    </script>    
</body>
</html>
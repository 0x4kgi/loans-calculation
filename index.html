<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="css/vendors/css.css">

    <title>Loan calculation</title>
</head>
<body>
    <h3>Loans Calculator</h3>
    

    <div class="container">
        <div class="row">
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Loan Amount:</span>
                </div>
                <div class="input-group-prepend">
                    <span class="input-group-text ">$</span>
                </div>
                <input type="text" class="form-control text-right" placeholder="10000" id="txtLoans">
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Interest:</span>
                </div>                
                <input 
                    type="text" 
                    class="form-control text-right" 
                    placeholder="2.5" 
                    id="txtInterest"
                    onkeyup="updateAnnum(this)"
                >
                <div class="input-group-append">
                    <span class="input-group-text">% /month</span>
                </div>
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Interest:</span>
                </div>                
                <input type="text" class="form-control text-right" placeholder="0.208" id="txtInterestAnnum" readonly>
                <div class="input-group-append">
                    <span class="input-group-text">% /annum</span>
                </div>
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Terms:</span>
                </div>                
                <input type="text" class="form-control text-right" placeholder="3" id="txtYears">
                <div class="input-group-append">
                    <span class="input-group-text">years</span>
                </div>
            </div>                      
        </div>
        <br>
        <div class="row">
            <div class="col-xm-12">
                <button type="button" class="btn btn-primary" id="btnUpdateTable">Set Values</button>
            </div>
        </div>        
    </div>
    <br>
    <div class="container">
        <div class="row">
            <table class="table table-bordered table-sm col-sm">
                <thead>
                    <th>Month #</th>
                    <th>Balance</th>
                    <th>Amount to pay</th>
                    <th>Payment</th>
                    <th>Interest</th>
                    <th>Principal</th>
                    <th>New Balance</th>
                </thead>
                <tbody id="tblLoans">
                    
                </tbody>
            </table>
        </div>
    </div>
    <script src="scripts/vendors/js.js"></script>
    <script src="scripts/constants.js"></script>
    <script src="scripts/formulas.js"></script>
    <script>
        var monthsArray = [];

        let loanAmount = DEFAULT_LOAN_AMOUNT;
        let interestRate = DEFAULT_INTEREST / 100;
        let monthsCount = DEFAULT_YEARS * 12;

        $(document).ready(function() {
            $("button#btnUpdateTable").on("click", function() {
                loanAmount = $("input#txtLoans").val() || DEFAULT_LOAN_AMOUNT;
                interestRate = ($("input#txtInterest").val() || DEFAULT_INTEREST) / 100;
                monthsCount = ($("input#txtYears").val() || DEFAULT_YEARS) * 12;

                resetTable();

                let balance = loanAmount;
                
                for (let i = 0; i < monthsCount; i += 1) {
                    let toPay = PMT({rate: interestRate, term: monthsCount - i, loan: loanAmount});
                    let payment = 0;
                    let interestValue = interestValueCalculation(balance, interestRate);
                    let principal = 0;
                    let newBalance = balance - principal;                    

                    appendToTable({
                        month: i,
                        balance, toPay, interestValue, principal, newBalance
                    });   
                    
                    balance = newBalance;                    
                }
            });
        });

        function appendToTable({month, balance, toPay, interestValue, principal, newBalance}) {
            monthsArray.push({month, balance, toPay, interestValue, principal, newBalance, payment: 0});
            $("tbody#tblLoans").append(`
                <tr id="rowMonth${month}">
                    <td class="text-center">${month + 1}</td>
                    <td class="text-right" 
                        id="balance${month}">
                        ${numberFormat(monthsArray[month].balance)}
                    </td>
                    <td class="text-right" 
                        id="payment${month}">
                        ${numberFormat(toPay)}
                    </td>
                    <td class="text-right">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <button 
                                    class="btn btn-outline-secondary" 
                                    type="button"
                                    onClick="equalizePayments(${month});">
                                    &gt;&gt;
                                </button>    
                            </div>
                            <input 
                                type="text" 
                                class="form-control text-right" 
                                placeholder="0.00" 
                                id="payment${month}"
                                onKeyUp="paymentTextChange(this,${month})"
                            >
                        </div>                        
                    </td>
                    <td class="text-right" 
                        id="interest${month}">
                        ${numberFormat(monthsArray[month].interestValue)}
                    </td>
                    <td class="text-right" 
                        id="principal${month}">
                        ${numberFormat(monthsArray[month].principal)}
                    </td>
                    <td class="text-right" 
                        id="newBalance${month}">
                        ${numberFormat(monthsArray[month].newBalance)}
                    </td>
                </tr>
            `);
            
        }

        function resetTable() {
            monthsArray = [];
            $("tbody#tblLoans").html("");
        }

        function paymentTextChange(control,monthIndex) {
            let value = stringToNumber($(`input#payment${monthIndex}`).val());

            let monthData = monthsArray[monthIndex];
            
            monthData.payment = value || DEFAULT_PAYMENT;
            monthData.interestValue = interestValueCalculation(
                monthData.balance,
                interestRate
            );
            monthData.principal = principalCalculation(
                value, 
                monthData.interestValue
            );
            monthData.newBalance = monthData.balance - monthData.principal; 

            monthsArray[monthIndex] = monthData;
            updateTableDisplay(monthIndex);
            updateTableData(monthIndex);
        }

        function updateTableData(monthIndex) {
            for (let m = monthIndex + 1; m <= monthsCount; m += 1) {
                let previousMonthData = monthsArray[m - 1];
                let currentMonthData = monthsArray[m];

                if (currentMonthData === undefined) break;

                currentMonthData.balance = previousMonthData.newBalance;
                currentMonthData.toPay = PMT({
                    rate: interestRate,
                    term: monthsCount - m,
                    loan: currentMonthData.balance
                });
                currentMonthData.payment = $(`input#payment${m}`).val() || DEFAULT_PAYMENT;
                currentMonthData.interestValue = interestValueCalculation(
                    currentMonthData.balance,
                    interestRate
                );
                currentMonthData.principal = principalCalculation(
                    $(`input#payment${m}`).val(), 
                    currentMonthData.interestValue
                );
                currentMonthData.newBalance = currentMonthData.balance - currentMonthData.principal; 

                monthsArray[m] = currentMonthData;

                updateTableDisplay(m);
            }
        }

        function updateTableDisplay(monthIndex) {
            $(`td#balance${monthIndex}`).html(numberFormat(monthsArray[monthIndex].balance));
            $(`td#payment${monthIndex}`).html(numberFormat(monthsArray[monthIndex].toPay));
            $(`td#interest${monthIndex}`).html(numberFormat(monthsArray[monthIndex].interestValue));
            $(`td#principal${monthIndex}`).html(numberFormat(monthsArray[monthIndex].principal));
            $(`td#newBalance${monthIndex}`).html(numberFormat(monthsArray[monthIndex].newBalance));
        }

        function numberFormat(number, places = 2) {
            let rounded =  Math.round(number * Math.pow(10, places)) / Math.pow(10, places);
            
            num = parseFloat(rounded).toLocaleString(undefined, {maximumFractionDigits:places});

            let decimals = num.toString().split(".")[1];
            if(decimals === undefined){
                num += ".".padEnd(places + 1, 0);
            } else if(decimals.length < places) {
                num += "0".padEnd(places - decimals.length);
            }

            return num;
        }

        function stringToNumber(data) {
            str = data.toString();

            if (str.indexOf(".") > -1) {
                split = str.split(".");

                if(split[1] === undefined) return 0;

                split[0] = split[0].replace(/\D+/g, "");
                split[1] = split[1].replace(/\D+/g, "");

                return parseFloat(`${split[0]}.${split[1]}`);
            } else {
                return str.replace(/\D+/g, "");
            }   
        }

        function updateAnnum(control) {
            let value = stringToNumber(control.value) * 12;

            $("input#txtInterestAnnum").val(numberFormat(value,3));
        }
        
        function equalizePayments(monthIndex) {
            let monthly = stringToNumber($(`td#payment${monthIndex}`).html());
            $(`input#payment${monthIndex}`).val(monthly);
            paymentTextChange($(`input#payment${monthIndex}`), monthIndex);
        }
    </script>    
</body>
</html>
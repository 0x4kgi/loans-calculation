<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="css/vendors/css.css">

    <title>Loan calculation</title>
</head>
<body>
    <h3>Loans Calculator</h3>


    <div class="container">
        <div class="row">
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Loan Amount:</span>
                </div>
                <div class="input-group-prepend">
                    <span class="input-group-text">$</span>
                </div>
                <input type="text" class="form-control" placeholder="10000" id="txtLoans">
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Interest:</span>
                </div>                
                <input type="text" class="form-control" placeholder="2.5" id="txtInterest">
                <div class="input-group-append">
                    <span class="input-group-text">% per month</span>
                </div>
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Interest:</span>
                </div>                
                <input type="text" class="form-control" placeholder="2.5" id="txtInterestAnnum" readonly>
                <div class="input-group-append">
                    <span class="input-group-text">% per annum</span>
                </div>
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Terms:</span>
                </div>                
                <input type="text" class="form-control" placeholder="3" id="txtYears">
                <div class="input-group-append">
                    <span class="input-group-text">years</span>
                </div>
            </div>                      
        </div>
        <br>
        <div class="row">
            <div class="col-xm-12">
                <button type="button" class="btn btn-primary" id="btnUpdateTable">Set Values</button>
            </div>
        </div>        
    </div>
    <br>
    <div class="container">
        <div class="row">
            <table class="table table-bordered table-sm col-sm">
                <thead>
                    <th>Month #</th>
                    <th>Balance</th>
                    <th>Amount to pay</th>
                    <th>Payment</th>
                    <th>Interest</th>
                    <th>Principal</th>
                    <th>New Balance</th>
                </thead>
                <tbody id="tblLoans">
                    
                </tbody>
            </table>
        </div>
    </div>
    
    
    <script src="scripts/vendors/js.js"></script>
    <script>
        const DEFAULT_LOAN_AMOUNT = 10000;
        const DEFAULT_INTEREST = 2.5;
        const DEFAULT_INTEREST_ANNUM = DEFAULT_INTEREST / 12;
        const DEFAULT_YEARS = 3;
        const DEFAULT_PAYMENT = 0;

        var monthsArray = [];

        let loanAmount = DEFAULT_LOAN_AMOUNT;
        let interestRate = DEFAULT_INTEREST / 100;
        let monthsCount = DEFAULT_YEARS * 12;

        $(document).ready(function() {
            $("button#btnUpdateTable").on("click", function() {
                loanAmount = $("input#txtLoans").val() || DEFAULT_LOAN_AMOUNT;
                interestRate = ($("input#txtInterest").val() || DEFAULT_INTEREST) / 100;
                monthsCount = ($("input#txtYears").val() || DEFAULT_YEARS) * 12;

                resetTable();

                let balance = loanAmount;
                
                for (let i = 0; i < monthsCount; i += 1) {
                    let toPay = PMT({rate: interestRate, term: monthsCount - i, loan: loanAmount});
                    let payment = 0;
                    let interestValue = balance * (interestRate / 12);
                    let principal = 0;
                    let newBalance = balance - principal;                    

                    appendToTable({
                        month: i,
                        balance, toPay, interestValue, principal, newBalance
                    });   
                    
                    balance = newBalance;                    
                }
                totalAnnumInterest();
            });
        });

        function appendToTable({month, balance, toPay, interestValue, principal, newBalance}) {
            monthsArray.push({month, balance, toPay, interestValue, principal, newBalance, payment: 0});
            $("tbody#tblLoans").append(`
                <tr id="rowMonth${month}">
                    <td class="text-center">${month + 1}</td>
                    <td class="text-right" 
                        id="balance${month}">${numberFormat(monthsArray[month].balance)}</td>
                    <td class="text-right" 
                        id="payment${month}">${numberFormat(toPay)}</td>
                    <td class="text-right" >
                        <input 
                            type="text" 
                            class="form-control text-right" 
                            placeholder="0.00" 
                            id="payment${month}"
                            onKeyUp="paymentTextChange(this,${month})"
                        >
                    </td>
                    <td class="text-right" 
                        id="interest${month}">${numberFormat(monthsArray[month].interestValue)}</td>
                    <td class="text-right" 
                        id="principal${month}">${numberFormat(monthsArray[month].principal)}</td>
                    <td class="text-right" 
                        id="newBalance${month}">${numberFormat(monthsArray[month].newBalance)}</td>
                </tr>
            `);
            
        }

        function resetTable() {
            monthsArray = [];
            $("tbody#tblLoans").html("");
        }

        var delay;
        function paymentTextChange(control,monthIndex) {
            let value = control.value;

            let monthData = monthsArray[monthIndex];
            
            monthData.payment = value || DEFAULT_PAYMENT;
            monthData.interestValue = monthData.balance * (interestRate / 12);
            monthData.principal = $(`input#payment${monthIndex}`).val() 
                ? monthData.payment - monthData.interestValue
                : DEFAULT_PAYMENT;
            monthData.newBalance = monthData.balance - monthData.principal; 

            monthsArray[monthIndex] = monthData;
            updateTableDisplay(monthIndex);
            updateTableData(monthIndex);
        }

        function updateTableData(monthIndex) {
            for (let m = monthIndex + 1; m <= monthsCount; m += 1) {
                let previousMonthData = monthsArray[m - 1];
                let currentMonthData = monthsArray[m];

                if (currentMonthData === undefined) break;

                currentMonthData.balance = previousMonthData.newBalance;
                currentMonthData.toPay = PMT({
                    rate: interestRate,
                    term: monthsCount - m,
                    loan: currentMonthData.balance
                });
                currentMonthData.payment = $(`input#payment${m}`).val() || DEFAULT_PAYMENT;
                currentMonthData.interestValue = currentMonthData.balance * (interestRate / 12);
                currentMonthData.principal = $(`input#payment${m}`).val() 
                    ? currentMonthData.payment - currentMonthData.interestValue
                    : DEFAULT_PAYMENT;
                currentMonthData.newBalance = currentMonthData.balance - currentMonthData.principal; 

                monthsArray[m] = currentMonthData;

                updateTableDisplay(m);
            }
        }

        function updateTableDisplay(monthIndex) {
            $(`td#balance${monthIndex}`).html(numberFormat(monthsArray[monthIndex].balance));
            $(`td#payment${monthIndex}`).html(numberFormat(monthsArray[monthIndex].toPay));
            $(`td#interest${monthIndex}`).html(numberFormat(monthsArray[monthIndex].interestValue));
            $(`td#principal${monthIndex}`).html(numberFormat(monthsArray[monthIndex].principal));
            $(`td#newBalance${monthIndex}`).html(numberFormat(monthsArray[monthIndex].newBalance));
        }

        function PMT({rate, term, loan}) {
            rate = rate / 12;
            return rate * (-loan) * Math.pow((1 + rate), term) / (1 - Math.pow((1 + rate), term))
        }

        function numberFormat(number, places = 2) {
            let rounded =  Math.round(number * Math.pow(10, places)) / Math.pow(10, places);
            
            num = parseFloat(rounded).toLocaleString(undefined, {maximumFractionDigits:places});

            let decimals = num.toString().split(".")[1];
            if(decimals === undefined){
                num += ".".padEnd(places + 1, 0);
            } else if(decimals.length < places) {
                num += "0".padEnd(places - decimals.length);
            }

            return num;
        }

        function totalAnnumInterest() {
            var interestTotal = 0;
            monthsArray.forEach((item) => {
                interestTotal += item.interestValue;
                console.log(item, item.interestValue);
            });
            console.log(interestTotal);
        }
    </script>    
</body>
</html>
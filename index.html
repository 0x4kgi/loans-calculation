<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="css/vendors/css.css">

    <title>Loan calculation</title>
</head>
<body>
    <h3>Loans Calculator</h3>


    <div class="container">
        <div class="row">
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Loan Amount:</span>
                </div>
                <div class="input-group-prepend">
                    <span class="input-group-text">$</span>
                </div>
                <input type="text" class="form-control" placeholder="10000" id="txtLoans">
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Interest:</span>
                </div>                
                <input type="text" class="form-control" placeholder="2.5" id="txtInterest">
                <div class="input-group-append">
                    <span class="input-group-text">% per month</span>
                </div>
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Interest:</span>
                </div>                
                <input type="text" class="form-control" placeholder="2.5" id="txtInterestAnnum" readonly>
                <div class="input-group-append">
                    <span class="input-group-text">% per annum</span>
                </div>
            </div>
            <div class="input-group col-sm">
                <div class="input-group-prepend">
                    <span class="input-group-text">Terms:</span>
                </div>                
                <input type="text" class="form-control" placeholder="3" id="txtYears">
                <div class="input-group-append">
                    <span class="input-group-text">years</span>
                </div>
            </div>                      
        </div>
        <br>
        <div class="row">
            <div class="col-xm-12">
                <button type="button" class="btn btn-primary" id="btnUpdateTable">Set Values</button>
            </div>
        </div>        
    </div>
    <br>
    <div class="container">
        <div class="row">
            <table class="table table-bordered col-sm" id="tblLoans">
                <tr>
                    <th>Month #</th>
                    <th>Balance</th>
                    <th>Amount to pay</th>
                    <th>Payment</th>
                    <th>Interest</th>
                    <th>Principal</th>
                    <th>New Balance</th>
                </tr>
            </table>
        </div>
    </div>
    
    
    <script src="scripts/vendors/js.js"></script>
    <script>
        const DEFAULT_LOAN_AMOUNT = 10000;
        const DEFAULT_INTEREST = 2.5;
        const DEFAULT_YEARS = 3;
        const DEFAULT_PAYMENT = 0;

        var monthsArray = [];

        let loanAmount = DEFAULT_LOAN_AMOUNT;
        let interestRate = DEFAULT_INTEREST / 100;
        let monthsCount = DEFAULT_YEARS * 12;

        $(document).ready(function() {
            $("button#btnUpdateTable").on("click", function() {
                loanAmount = $("input#txtLoans").val() || DEFAULT_LOAN_AMOUNT;
                interestRate = ($("input#txtInterest").val() || DEFAULT_INTEREST) / 100;
                monthsCount = ($("input#txtYears").val() || DEFAULT_YEARS) * 12;

                resetTable();

                let balance = loanAmount;
                
                for (let i = 0; i < monthsCount; i += 1) {
                    let toPay = PMT({rate: interestRate, term: monthsCount - i, loan: loanAmount});
                    let payment = 0;
                    let interestValue = balance * (interestRate / 12);
                    let principal = (payment - interestValue > 0) ? payment - interestValue : 0;
                    let newBalance = balance - principal;                    

                    appendToTable({
                        month: i,
                        balance, toPay, interestValue, principal, newBalance
                    });   
                    
                    balance = newBalance;
                }
            });
        });

        function appendToTable({month, balance, toPay, interestValue, principal, newBalance}) {
            monthsArray.push({month, balance, toPay, interestValue, principal, newBalance, payment: 0});
            $("table#tblLoans").append(`
                <tr id="rowMonth${month}">
                    <td>${month + 1}</td>
                    <td id="balance${month}">${numberFormat(monthsArray[month].balance)}</td>
                    <td id="payment${month}">${numberFormat(toPay)}</td>
                    <td>
                        <input 
                            type="text" 
                            class="form-control" 
                            placeholder="0.00" 
                            id="payment${month}"
                            onKeyUp="paymentTextChange(this,${month})"
                        >
                    </td>
                    <td id="interest${month}">${numberFormat(monthsArray[month].interestValue)}</td>
                    <td id="principal${month}">${numberFormat(monthsArray[month].principal)}</td>
                    <td id="newBalance${month}">${numberFormat(monthsArray[month].newBalance)}</td>
                </tr>
            `);
        }

        function resetTable() {
            monthsArray = [];
            $("table#tblLoans").find("tr:gt(0)").remove();
        }

        var delay;
        function paymentTextChange(control,monthIndex) {
            let value = control.value;

            clearTimeout(delay);
            delay = setTimeout(function () {

                let monthData = monthsArray[monthIndex];
                
                monthData.payment = value || DEFAULT_PAYMENT;
                monthData.interestValue = monthData.balance * (interestRate / 12);
                monthData.principal = monthData.payment - monthData.interestValue;
                monthData.newBalance = monthData.balance - monthData.principal; 

                monthsArray[monthIndex] = monthData;
                updateTableDisplay(monthIndex);
                updateTableData(monthIndex);
            }, 250);
        }

        function updateTableData(monthIndex) {
            for (let m = monthIndex + 1; m <= monthsCount; m += 1) {
                let previousMonthData = monthsArray[m - 1];
                let currentMonthData = monthsArray[m];

                currentMonthData.balance = previousMonthData.newBalance;
                currentMonthData.toPay = PMT({
                    rate: interestRate,
                    term: monthsCount - m,
                    loan: currentMonthData.balance
                });
                currentMonthData.payment = $(`input#payment${m}`).val() || DEFAULT_PAYMENT;
                currentMonthData.interestValue = currentMonthData.balance * (interestRate / 12);
                currentMonthData.principal = currentMonthData.payment - currentMonthData.interestValue// > 0) 
                    //? currentMonthData.payment - currentMonthData.interestValue 
                    //: 0;
                currentMonthData.newBalance = currentMonthData.balance - currentMonthData.principal; 

                monthsArray[m] = currentMonthData;

                updateTableDisplay(m);
            }
        }

        function updateTableDisplay(monthIndex) {
            $(`td#balance${monthIndex}`).html(numberFormat(monthsArray[monthIndex].balance));
            $(`td#payment${monthIndex}`).html(numberFormat(monthsArray[monthIndex].toPay));
            $(`td#interest${monthIndex}`).html(numberFormat(monthsArray[monthIndex].interestValue));
            $(`td#principal${monthIndex}`).html(numberFormat(monthsArray[monthIndex].principal));
            $(`td#newBalance${monthIndex}`).html(numberFormat(monthsArray[monthIndex].newBalance));
        }

        function PMT({rate, term, loan}) {
            rate = rate / 12;
            return rate * (-loan) * Math.pow((1 + rate), term) / (1 - Math.pow((1 + rate), term))
        }

        function numberFormat(number, places = 2) {
            let rounded =  Math.round(number * Math.pow(10, places)) / Math.pow(10, places);
            if(!(rounded.toString().indexOf(".") > -1)) {
                rounded += ".";
                
                for (let i = 0; i < places; i++) {
                    rounded += "0";
                }
            } else {
                let decimals = rounded.toString().split(".")[1];

                if(decimals.length < places) {
                    for (let i = 0; i < places - decimals.length; i++) {
                        rounded += "0";
                    }
                }
            }
            return rounded;
        }
    </script>    
</body>
</html>